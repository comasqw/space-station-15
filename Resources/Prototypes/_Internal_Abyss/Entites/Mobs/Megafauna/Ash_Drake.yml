## HTN
- type: htnCompound
  id: MeleeAttackTargetCompound
  branches:
    - preconditions:
      - !type:KeyExistsPrecondition
        key: Target
      tasks:
        - !type:HTNPrimitiveTask
          operator: !type:JukeOperator
            jukeType: Away
        - !type:HTNPrimitiveTask
          operator: !type:MeleeOperator
            targetKey: Target
          preconditions:
            - !type:KeyExistsPrecondition
              key: Target
            - !type:TargetInRangePrecondition
              targetKey: Target
              rangeKey: MeleeRange
          services:
            - !type:UtilityService
              id: MeleeService
              proto: NearbyMeleeTargets
              key: Target

- type: htnCompound
  id: AshDrakeCompound
  branches:
    - tasks:
        - !type:HTNCompoundTask
          task: MeleeAttackTargetCompound
    - tasks:
        - !type:HTNCompoundTask
          task: IdleCompound


## Mob

- type: entity
  parent: [ SimpleSpaceMobBase, FlyingMobBase ]
  id: IAMobAshDrake
  name: space dragon
  description: A flying leviathan, loosely related to space carps.
  components:
  - type: Bloodstream
    bloodMaxVolume: 650
  - type: HTN
    rootTask:
      task: AshDrakeCompound
    blackboard:
      NavInteract: !type:Bool
        true
      NavPry: !type:Bool
        true
      NavSmash: !type:Bool
        true
  - type: NpcFactionMember
    factions:
    - Dragon
  - type: Speech
    speechVerb: LargeMob
  - type: CombatMode
  - type: MobMover
  - type: InputMover
  - type: MovementSpeedModifier
    baseWalkSpeed: 3
    baseSprintSpeed: 5
    weightlessModifier: 1.5
  - type: RandomSprite
    available:
    - enum.DamageStateVisualLayers.Base:
        alive: Rainbow
  - type: Sprite
    sprite: Mobs/Aliens/Carps/dragon.rsi
    noRot: true
    layers:
    - map: [ "enum.DamageStateVisualLayers.Base" ]
      state: alive
    - map: [ "enum.DamageStateVisualLayers.BaseUnshaded" ]
      state: alive-unshaded
      shader: unshaded
  - type: Appearance
  - type: DamageStateVisuals
    states:
      Alive:
        Base: alive
        BaseUnshaded: alive-unshaded
      Critical:
        Base: crit
      Dead:
        Base: dead
        BaseUnshaded: dead-unshaded
  - type: Physics
    bodyType: KinematicController
  - type: Fixtures
    fixtures:
      fix1:
        shape:
          !type:PhysShapeCircle
          radius: 0.40
        density: 100
        mask:
        - FlyingMobMask
        layer:
        - FlyingMobLayer
  - type: MobState
  - type: MobStateActions
    actions:
      Critical:
      - ActionCritSuccumb
      - ActionCritLastWords
  - type: MobThresholds
    thresholds:
      0: Alive
      450: Critical
      500: Dead
  - type: SlowOnDamage
    speedModifierThresholds:
      250: 0.7
      400: 0.5
  # disable taking damage from fire, since its a fire breathing dragon
  - type: Flammable
    damage:
      types: {}
  - type: StatusEffects # Overwriting basesimplemob to remove flash, getting flashed as dragon just feelsbad
    allowed:
    - SlowedDown
    - Stutter
    - Electrocution
    - ForcedSleep
    - TemporaryBlindness
    - Pacified
    - RadiationProtection
    - Drowsiness
  - type: Temperature
    heatDamageThreshold: 800
  - type: Metabolizer
    solutionOnBody: false
    updateInterval: 0.25
    metabolizerTypes: [ Dragon ]
    groups:
    - id: Medicine
    - id: Poison
  - type: Butcherable
    spawned:
    - id: FoodMeatDragon
      amount: 2
  - type: InteractionPopup
    successChance: 0.25 # It's no goose, but you better smell like carp.
    interactSuccessString: petting-success-dragon
    interactFailureString: petting-failure-dragon
    interactFailureSound:
      path: /Audio/Animals/space_dragon_roar.ogg
    soundPerceivedByOthers: false # A 75% chance for a loud roar would get old fast.
  - type: MeleeWeapon
    altDisarm: false
    soundHit:
      path: /Audio/Weapons/Xeno/alien_claw_flesh3.ogg
    damage:
      types:
        Piercing: 15
        Slash: 15
  - type: Devourer
    foodPreference: Humanoid
    shouldStoreDevoured: true
    chemical: Ichor
    healRate: 15.0
    whitelist:
      components:
      - MobState
      - Door
      tags:
      - Wall
  - type: Tag
    tags:
    - CannotSuicide
    - DoorBumpOpener
  - type: DrakeArena
  - type: ActionGun
    action: ActionAshDrakeBreath
    gunProto: IAAshDrakeBreathGun
  - type: NPCUseActionOnTarget
    actionId: ActionAshDrakeArena


# Actions

- type: entity
  id: IAProjectileAshDrakeBreathLava
  parent: FloorLavaEntity
  components:
  - type: TimedDespawn
    lifetime: 3

- type: entity
  categories: [ HideSpawnMenu ]
  parent: BaseBulletTrigger
  id: IAProjectileAshDrakeBreath
  name: dragon's breath
  description: Try not to get toasted.
  components:
  - type: PointLight
    color: "#E25822"
    radius: 3.0
    energy: 5.0
  - type: Sprite
    sprite: Effects/fire.rsi
    layers:
    - state: "1"
      shader: unshaded
  - type: IgnitionSource
    temperature: 1000
    ignited: true
  - type: RepeatingTrigger
    delay: 0.1 # line of fire as well as if it hits something
  - type: SpawnOnTrigger
    proto: IAProjectileAshDrakeBreathLava
  - type: ExplodeOnTrigger
  - type: Explosive
    explosionType: FireBomb
    totalIntensity: 1 # low intensity, the point is to burn attackers not to break open walls, dragons can just eat them
    intensitySlope: 1
    maxIntensity: 3
    canCreateVacuum: false
    deleteAfterExplosion: false
    repeatable: true
  - type: TimedDespawn
    lifetime: 5

- type: entity
  id: IAProjectileAshDrakeBreathSpread
  categories: [ HideSpawnMenu ]
  parent: ProjectileDragonsBreath
  components:
  - type: ProjectileSpread
    proto: IAProjectileAshDrakeBreath
    count: 3
    spread: 60

- type: entity
  categories: [ HideSpawnMenu ]
  id: IAAshDrakeBreathGun
  name: dragon's lung
  description: For dragon's breathing.
  components:
  - type: RechargeBasicEntityAmmo
    rechargeCooldown: 5
    rechargeSound:
      path: /Audio/Animals/space_dragon_roar.ogg
  - type: BasicEntityAmmoProvider
    proto: ProjectileDragonsBreathSpread
    capacity: 1
    count: 1
  - type: Gun
    soundGunshot:
      path: /Audio/Animals/space_dragon_roar.ogg
    soundEmpty: null
    projectileSpeed: 3

- type: entity
  id: ActionAshDrakeBreath
  name: "[color=orange]Dragon's Breath[/color]"
  description: Spew out flames at anyone foolish enough to attack you!
  components:
  - type: EntityWorldTargetAction
    # TODO: actual sprite
    icon: { sprite : Objects/Weapons/Guns/Projectiles/magic.rsi, state: fireball }
    event: !type:ActionGunShootEvent
    raiseOnUser: true
    itemIconStyle: BigAction
    useDelay: 15
    range: 10

- type: entity
  id: ActionAshDrakeArena
  name: "[color=orange]Dragon's Arena[/color]"
  description: Spew out flames at anyone foolish enough to attack you!
  components:
  - type: EntityWorldTargetAction
    icon: { sprite : Objects/Weapons/Guns/Projectiles/magic.rsi, state: fireball }
    event: !type:DrakeArenaAction
    raiseOnUser: true
    itemIconStyle: BigAction
    useDelay: 30
    range: 10

- type: entity
  id: IAAshDrakeArenaPreLava
  components:
  - type: Sprite
    sprite: Tiles/Planet/lava.rsi
    drawdepth: BelowFloor
    layers:
      - state: full
        shader: unshaded
  - type: Tag
    tags:
      - HideContextMenu
  - type: Clickable
  - type: Transform
    anchored: true
  - type: TimedDespawn
    lifetime: 2
  - type: SpawnOnDespawn
    prototype: IAProjectileAshDrakeBreathLava

- type: entity
  id: IAAshDrakeArenaGreenZone
  components:
  - type: Sprite
    sprite: Markers/cross.rsi
    drawdepth: BelowFloor
    layers:
      - state: green
        shader: unshaded
  - type: Tag
    tags:
      - HideContextMenu
  - type: Clickable
  - type: Transform
    anchored: true
  - type: TimedDespawn
    lifetime: 2

- type: entity
  parent: WallPlastitaniumIndestructible
  id: IAAshDrakeArenaWall
  name: Ash Drake Arena Wall
  components:
    - type: Sprite
      sprite: Structures/Walls/plastitanium.rsi
    - type: PointLight
      color: "#E25822"
      radius: 3.0
      energy: 5.0
    - type: Sprite
      sprite: Effects/fire.rsi
      layers:
      - state: "1"
        shader: unshaded
    - type: Fixtures
      fixtures:
      fix1:
        shape:
          !type:PhysShapeAabb {}
        mask:
        - FullTileMask
        layer:
        - GlassLayer

